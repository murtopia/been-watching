# Social System Implementation Plan
**Date:** October 20, 2025
**Session:** Comprehensive Friends/Follow System Overhaul
**Token Status:** Starting at ~85k/200k

---

## 🎯 Overview

Implementing a complete social discovery system for Been Watching with:
- Username enforcement (no timestamps)
- Taste match algorithm for friend suggestions
- Smart discovery with search
- Clickable user profiles
- Admin social metrics dashboard

---

## ✅ Completed

### 1. Taste Match Algorithm (`utils/tasteMatch.ts`)
**Purpose:** Calculate similarity between users based on watch history and ratings

**Key Functions:**
- `getUserTasteProfile(userId)` - Fetches user's watched shows and ratings
- `calculateTasteMatch(user1, user2)` - Returns 0-100 score
- `findSimilarUsers(userId)` - Returns sorted list of compatible users
- `getTasteMatchLabel(score)` - Returns label, emoji, and color

**Score Categories:**
- 90-100: Exceptional Match 🔥
- 70-89: Great Match ⭐
- 50-69: Good Match 👍
- 30-49: Fair Match ✓
- 0-29: Different Taste •

**Algorithm:**
- 60% weight on rating agreement
- 40% weight on watch overlap
- Factors: shared shows, rating matches, partial agreements

**Future Use:**
- Friend suggestions (current)
- Show recommendations (planned)
- Social discovery features

---

### 2. Username Validation (`utils/usernameValidation.ts`)
**Purpose:** Enforce clean, memorable usernames

**Key Functions:**
- `isAutoGeneratedUsername(username)` - Detects timestamps, numbers-only, etc.
- `isValidUsername(username)` - Validates format (3-20 chars, a-z0-9_)
- `suggestUsername(displayName, email)` - Generates clean suggestion
- `cleanUsername(input)` - Removes invalid characters

**Validation Rules:**
- ❌ No timestamps (username_1234567890123)
- ❌ No numbers-only usernames
- ❌ Minimum 3 characters
- ✅ Only lowercase letters, numbers, underscores

---

### 3. Updated ProfileSetup Component
**File:** `components/onboarding/ProfileSetup.tsx`

**Changes:**
- Imports username validation utilities
- Pre-fills display name from OAuth data
- Suggests clean username (no timestamps)
- Uses `cleanUsername()` on input onChange
- Loads current profile to pre-populate fields

**User Flow:**
1. OAuth login → Profile created with `is_approved = false`
2. InviteCodeGate → User enters BOOZEHOUND
3. ProfileSetup → **Now suggests clean username**
4. Home feed loads

---

## 🚧 In Progress

### 4. Documentation & Token Management
**This file!** - Comprehensive plan with progress tracking

---

## 📋 Remaining Tasks

### Phase 1: Username Enforcement

#### Task A: Update app/page.tsx
**File:** `app/page.tsx`
**Changes Needed:**
```typescript
// Add import
import { isAutoGeneratedUsername } from '@/utils/usernameValidation'

// Update checkUser function (line 60-65)
else if (!profileData.username || isAutoGeneratedUsername(profileData.username)) {
  setShowProfileSetup(true)
}
```

**Current Logic (BROKEN):**
```typescript
// Line 61-63 - Too simplistic
else if (!profileData.username ||
         profileData.username.includes('_') || // Catches ALL underscores
         profileData.username === user.email?.split('@')[0]) {
  setShowProfileSetup(true)
}
```

**Problem:** Catches valid usernames with underscores like `john_smith`

---

### Phase 2: UI Components

#### Task B: Create UserCard Component
**File:** `components/friends/UserCard.tsx` (NEW)

**Design:**
```
┌─────────────────────────────────────┐
│  [Avatar]  @username       [Button] │
│            Display Name             │
│            Mutual: @mossy, @taylor  │
│            Taste Match: 🔥 92%      │
│            Watching: Peacemaker S2  │
└─────────────────────────────────────┘
```

**Props:**
```typescript
interface UserCardProps {
  user: Profile
  currentUserId: string
  isFollowing: boolean
  mutualFriends: Profile[]
  tasteMatchScore?: number
  latestActivity?: string
  onFollow: (userId: string) => void
  onUnfollow: (userId: string) => void
  onClick?: (username: string) => void // Navigate to profile
}
```

**Features:**
- Large avatar (60px) with gradient fallback
- **@username** in bold (primary identifier)
- Display name in regular weight below
- Mutual friends list (max 3 shown)
- Taste match score with emoji
- Latest activity preview
- Follow/Unfollow button with state
- Clickable card → navigate to user profile

---

#### Task C: Redesign Profile Page
**File:** `app/profile/page.tsx`

**Current Structure:**
- Single "Friends" section
- Two tabs: Following / Followers
- Basic "Suggested" section below

**New Structure:**
```
┌──────────────────────────────────────┐
│  Following  │  Followers  │ Discover │
│      2      │      0      │    🔍    │
└──────────────────────────────────────┘
```

**Tab 1: Following**
- Users you follow
- Show using UserCard component
- Show mutual friends
- Show taste match score
- Unfollow button

**Tab 2: Followers**
- Users who follow you
- Show using UserCard component
- "Follow Back" button if not following
- Show taste match score

**Tab 3: Discover (NEW)**
- **Search bar** at top
- Real-time search by username or display name
- **Smart Suggestions** below:
  1. Users with mutual friends (highest priority)
  2. Users with high taste match (70%+)
  3. Same invite tier (boozehounds)
  4. Most active users
- Each suggestion shows why it was suggested:
  - "Mutual friends with @mossy"
  - "🔥 92% taste match"
  - "Fellow Boozehound"

**Functions to Add:**
```typescript
const [discoverTab, setDiscoverTab] = useState<'following' | 'followers' | 'discover'>('following')
const [searchQuery, setSearchQuery] = useState('')
const [searchResults, setSearchResults] = useState<Profile[]>([])
const [smartSuggestions, setSmartSuggestions] = useState<SuggestedUser[]>([])

interface SuggestedUser {
  profile: Profile
  reason: string // Why suggested
  tasteMatchScore?: number
  mutualFriends: Profile[]
}

// Search function
const handleSearch = async (query: string) => {
  setSearchQuery(query)
  if (query.length < 2) {
    setSearchResults([])
    return
  }

  const { data } = await supabase
    .from('profiles')
    .select('*')
    .or(`username.ilike.%${query}%,display_name.ilike.%${query}%`)
    .neq('id', user.id)
    .limit(10)

  setSearchResults(data || [])
}

// Load smart suggestions
const loadSmartSuggestions = async () => {
  // 1. Get users with mutual friends
  // 2. Calculate taste match for top candidates
  // 3. Sort by priority (mutual > taste > tier > activity)
  // 4. Return top 10
}
```

---

### Phase 3: User Profiles

#### Task D: Create User Profile Page
**File:** `app/user/[username]/page.tsx` (NEW)

**Purpose:** Public profile view for any user

**URL:** `/user/mossy`, `/user/taylormurto`, etc.

**Layout:**
```
┌─────────────────────────────────────┐
│  [Avatar]  @mossy                   │
│            Pat Moss                 │
│            What have you been...    │
│                                     │
│  [Follow Button] [Message Button]  │
│                                     │
│  ───────────────────────────────── │
│  Stats: 3 Want | 4 Watching | 14...│
│  ───────────────────────────────── │
│                                     │
│  📺 Recent Activity                 │
│  • Rated Dune: Part Two 🔥 Love    │
│  • Watching Fallout S1              │
│  • Added 3 Body Problem to list     │
│                                     │
│  ⭐ Top 3 Shows                     │
│  1. [Show Card]                     │
│  2. [Show Card]                     │
│  3. [Show Card]                     │
└─────────────────────────────────────┘
```

**Privacy:**
- Respects `is_private` setting
- Shows activities only if:
  - Profile is public, OR
  - Viewer is following (accepted), OR
  - Viewer is the profile owner

**Features:**
- Follow/Unfollow button
- Taste match score (if following)
- Recent activity feed
- Top 3 shows
- Watch stats

---

### Phase 4: Admin Dashboard

#### Task E: Add Social Metrics Panel
**File:** `app/admin/page.tsx`

**New Section: Social Metrics**

**Metrics to Track:**
1. **Total Follows** - Count of all follow relationships
2. **Average Follows per User** - Total follows / total users
3. **Most Followed Users** - Top 10 with follower counts
4. **Most Active Users** - Top 10 by activity count (last 30 days)
5. **Taste Match Leaderboard** - Users with highest average compatibility
6. **Orphaned Users** - Users with 0 follows and 0 followers
7. **Follow Ratio Distribution** - Histogram of followers/following ratio

**Queries:**
```sql
-- Total follows
SELECT COUNT(*) FROM follows WHERE status = 'accepted';

-- Most followed
SELECT following_id, COUNT(*) as follower_count
FROM follows
WHERE status = 'accepted'
GROUP BY following_id
ORDER BY follower_count DESC
LIMIT 10;

-- Orphaned users
SELECT p.*
FROM profiles p
LEFT JOIN follows f1 ON p.id = f1.follower_id
LEFT JOIN follows f2 ON p.id = f2.following_id
WHERE f1.id IS NULL AND f2.id IS NULL;

-- Most active (last 30 days)
SELECT user_id, COUNT(*) as activity_count
FROM activities
WHERE created_at > NOW() - INTERVAL '30 days'
GROUP BY user_id
ORDER BY activity_count DESC
LIMIT 10;
```

**UI Design:**
```
┌─────────────────────────────────────┐
│  📊 Social Metrics                  │
├─────────────────────────────────────┤
│  Total Follows: 6                   │
│  Avg per User: 2.0                  │
│                                     │
│  🏆 Most Followed                   │
│  1. @mossy (2 followers)            │
│  2. @taylormurto (0 followers)      │
│                                     │
│  🔥 Most Active (30 days)           │
│  1. nick.murto (45 activities)      │
│  2. @mossy (12 activities)          │
│                                     │
│  ⚠️ Orphaned Users: 0               │
└─────────────────────────────────────┘
```

---

## 🔄 Development Workflow

**Testing Strategy:**
1. Test locally first (`npm run dev`)
2. Verify username validation works
3. Test friend cards render correctly
4. Test search functionality
5. Test user profile pages
6. Check admin dashboard metrics

**Deployment Process:**
1. All changes tested locally
2. Commit to git with descriptive message
3. Push to GitHub
4. Vercel auto-deploys from main branch
5. Verify production deployment
6. Check Sentry for any errors

**Git Commands:**
```bash
git add .
git commit -m "Implement comprehensive social system with taste match algorithm and user profiles"
git push origin main
```

---

## 📁 File Changes Summary

### New Files Created:
- `utils/tasteMatch.ts` - Taste match algorithm
- `utils/usernameValidation.ts` - Username validation
- `components/friends/UserCard.tsx` - Reusable user card component
- `app/user/[username]/page.tsx` - Public user profile page
- `SOCIAL-SYSTEM-IMPLEMENTATION.md` - This documentation

### Files to Modify:
- `app/page.tsx` - Update username validation check
- `app/profile/page.tsx` - Add Discover tab, search, smart suggestions
- `app/admin/page.tsx` - Add social metrics panel
- `components/onboarding/ProfileSetup.tsx` - ✅ Already updated

---

## 🎨 Design Principles

**Username Display:**
- **@username** = Bold, prominent (unique identifier)
- Display Name = Regular weight (friendly name)
- Never show timestamps to users

**User Cards:**
- Large avatars (60px)
- Gradient fallback for no-avatar users
- Show mutual connections
- Show taste compatibility
- Show latest activity
- One-click follow/unfollow

**Discovery:**
- Search-first approach
- Smart suggestions with reasoning
- Prioritize mutual friends
- Show compatibility scores
- Make it easy to find friends

---

## 📊 Token Management

**Current:** ~85k / 200k tokens used
**Strategy:**
- Create progress docs at 100k, 150k, 175k
- Document decisions and code changes
- Include SQL queries and component designs
- Ensure continuity for next session

**Next Documentation Milestones:**
- **At 100k tokens:** Create `SOCIAL-SYSTEM-PROGRESS-100K.md`
- **At 150k tokens:** Create `SOCIAL-SYSTEM-PROGRESS-150K.md`
- **At 175k tokens:** Create `SOCIAL-SYSTEM-FINAL-STATUS.md`

---

## 🐛 Known Issues to Address

1. **Params warnings** - Next.js 15 async params (Sentry will filter)
2. **Timestamp usernames** - Need to force ProfileSetup for existing users
3. **Duplicate profiles** - Taylor appears twice in suggested (need unique check)
4. **Missing avatars** - Many users showing initials only

---

## 🚀 Success Criteria

**Phase 1 Complete When:**
- [x] Taste match algorithm working
- [x] Username validation working
- [ ] All users forced to customize timestamp usernames
- [ ] ProfileSetup suggests clean usernames

**Phase 2 Complete When:**
- [ ] UserCard component created
- [ ] Profile page has 3-tab system
- [ ] Search functionality working
- [ ] Smart suggestions showing with reasons

**Phase 3 Complete When:**
- [ ] User profile pages created
- [ ] Profiles respect privacy settings
- [ ] Follow/unfollow works from profile pages

**Phase 4 Complete When:**
- [ ] Admin dashboard shows social metrics
- [ ] All metrics queries working
- [ ] Orphaned users identified

**Full Success When:**
- [ ] Everything tested locally
- [ ] Deployed to Vercel production
- [ ] No errors in Sentry
- [ ] User can discover friends easily
- [ ] Taste match scores displayed
- [ ] Admin can monitor social health

---

## 📝 Notes for Next Session

If we run out of tokens, continue from here:

**Priority Order:**
1. ✅ Taste match algorithm (DONE)
2. ✅ Username validation (DONE)
3. ✅ ProfileSetup updates (DONE)
4. ⏭️ Update app/page.tsx
5. ⏭️ Create UserCard component
6. ⏭️ Redesign profile page
7. ⏭️ Add user search
8. ⏭️ Smart suggestions
9. ⏭️ User profile pages
10. ⏭️ Admin dashboard

**Current Users:**
- nick.murto_1760924937322 (needs username fix)
- @mossy (Pat) - Good username ✓
- @taylormurto (Taylor) - Good username ✓

**Test Plan:**
1. Force nick.murto to customize username
2. Test search finds @mossy and @taylormurto
3. Test taste match calculation
4. Test mutual friends display
5. Navigate to user profiles
6. Check admin metrics

---

*End of documentation. Resume implementation below.*
